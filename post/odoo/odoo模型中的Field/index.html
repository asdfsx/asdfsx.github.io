<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="odoo模型中的Field">
  <meta name="generator" content="Hugo 0.19-DEV" />

  <title>odoo模型中的Field &middot; asdfsx</title>

  
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/pure-min.css">

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-old-ie-min.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-min.css">
  <!--<![endif]-->

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://asdfsx.github.io/css/side-menu-old-ie.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://asdfsx.github.io/css/side-menu.css">
  <!--<![endif]-->

  <link rel="stylesheet" href="https://asdfsx.github.io/css/blackburn.css">

  
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">

  
  <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet" type="text/css">

  
  

  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.1.0/styles/androidstudio.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.1.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  

  <link rel="shortcut icon" href="https://asdfsx.github.io/img/favicon.ico" type="image/x-icon" />

  
    <link rel="stylesheet" href="https://asdfsx.github.io/css/my.css">
  
  
    <script src="https://asdfsx.github.io/js/my.js"></script>
  

</head>


<body>
<div id="layout">

  
<a href="#menu" id="menuLink" class="menu-link">
  
  <span></span>
</a>
<div id="menu">

  
  <a class="pure-menu-heading brand" href="https://asdfsx.github.io/">asdfsx</a>


  <div class="pure-menu">
    <ul class="pure-menu-list">
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://asdfsx.github.io/"><i class='fa fa-home fa-fw'></i>Home</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://asdfsx.github.io/post/"><i class='fa fa-list fa-fw'></i>Posts</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://asdfsx.github.io/tags/"><i class='fa fa-list fa-fw'></i>Tags</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://asdfsx.github.io/about/"><i class='fa fa-user fa-fw'></i>About</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://asdfsx.github.io/contact/"><i class='fa fa-phone fa-fw'></i>Contact</a>
      
        </li>
      
    </ul>
  </div>

  <div class="pure-menu social">
  <ul class="pure-menu-list">

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://plus.google.com/+asdfsx" target="_blank"><i class="fa fa-google-plus-square fa-fw"></i>Google+</a>
    </li>
    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="http://weibo.com/*" target="_blank"><i class="fa fa-weibo fa-fw"></i>Weibo</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://github.com/asdfsx" target="_blank"><i class="fa fa-github-square fa-fw"></i>GitHub</a>
    </li>
    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://bitbucket.org/asdfsx" target="_blank"><i class="fa fa-bitbucket-square fa-fw"></i>Bitbucket</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

  </ul>
</div>


  <div>
  <div class="small-print">
    <small>&copy; 2016. All rights reserved.</small>
  </div>
  <div class="small-print">
    <small>Built with&nbsp;<a href="https://gohugo.io/" target="_blank">Hugo</a></small>
    <small>Theme&nbsp;<a href="https://github.com/yoshiharuyamashita/blackburn" target="_blank">Blackburn</a></small>
  </div>
</div>

</div>


  <div id="main">


<div class="header">
  <h1>odoo模型中的Field</h1>
  <h2>odoo模型中的Field</h2>
</div>
<div class="content">

  <div class="post-meta">

  <div>
    <i class="fa fa-calendar fa-fw"></i>
    <time>05 Jan 2017, 12:39</time>
  </div>

  

  
  
  
  <div>
    <i class="fa fa-folder fa-fw"></i>
    
      <a class="post-taxonomy-topic" href="https://asdfsx.github.io/topics/topic-1">topic 1</a>
    
  </div>
  
  

  
  
  
  <div>
    <i class="fa fa-tags fa-fw"></i>
    
      <a class="post-taxonomy-tag" href="https://asdfsx.github.io/tags/python">python</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="https://asdfsx.github.io/tags/odoo">odoo</a>
    
  </div>
  
  

</div>

  

<p><code>Odoo</code>的定义了自己的一套<code>ORM</code>系统。其中的一个重要组成部分就是字段的处理。这部分的内容都在<code>odoo.field</code>中。和其他模块一样，也大量使用了python的特殊语法，如：元类、<code>__slots__</code>、特殊函数，等。</p>

<h3 id="元类-odoo-fields-metafield">元类：odoo.fields.MetaField</h3>

<p>所有的字段类型的元类。如果一个字段类型使用了这个类，那么在创建这个类型时元类会扫描类中是否有<code>_slots</code>属性。如果有的话，会将<code>_slots</code>中的东西放到<code>__slots__</code>中。然后在初始化这个类型的时候，会把这个新创建的类型放在<code>MetaField</code>的<code>by_type</code>字典中。</p>

<p>注：<code>__slots__</code>的作用是用来存放类实例中的属性。默认，python中的实例是存放在<code>__dict__</code>中的；如果声明了<code>__slots__</code>就不会创建<code>__dict__</code>；<code>__slots__</code>应该比
<code>__dict__</code>节省空间。</p>

<pre><code>class MetaField(type):
    &quot;&quot;&quot; Metaclass for field classes. &quot;&quot;&quot;
    by_type = {}
    
    def __new__(meta, name, bases, attrs):
        &quot;&quot;&quot; Combine the ``_slots`` dict from parent classes, and determine
        ``__slots__`` for them on the new class.
        &quot;&quot;&quot;
        base_slots = {}
        for base in reversed(bases):
            base_slots.update(getattr(base, '_slots', ()))

        slots = dict(base_slots)
        slots.update(attrs.get('_slots', ()))

        attrs['__slots__'] = set(slots) - set(base_slots)
        attrs['_slots'] = slots
        return type.__new__(meta, name, bases, attrs)

    def __init__(cls, name, bases, attrs):
        super(MetaField, cls).__init__(name, bases, attrs)
        if cls.type and cls.type not in MetaField.by_type:
            MetaField.by_type[cls.type] = cls

        # compute class attributes to avoid calling dir() on fields
        cls.related_attrs = []
        cls.description_attrs = []
        for attr in dir(cls):
            if attr.startswith('_related_'):
                cls.related_attrs.append((attr[9:], attr))
            elif attr.startswith('_description_'):
                cls.description_attrs.append((attr[13:], attr))
</code></pre>

<h3 id="基类-odoo-fields-field">基类：odoo.fields.Field</h3>

<p>所有字段类的基类。定义了一个长长的<code>_slots</code>；定义了字段用到的大部分方法；定义了类型转换的方法<code>convert_to_read</code>、<code>convert_to_column</code>等，以便子类扩展。</p>

<pre><code>class Field(object):
    __metaclass__ = MetaField
    type = None                         # type of the field (string)
    relational = False                  # whether the field is a relational one
    translate = False                   # whether the field is translated

    column_type = None                  # database column type (ident, spec)
    column_format = '%s'                # placeholder for value in queries
    ......
</code></pre>

<h3 id="布尔型-odoo-fields-boolean">布尔型：odoo.fields.Boolean</h3>

<p>布尔类型是最简单的一个实现。可以看到通过覆盖<code>convert_to_column</code>函数，定义了如何将数据库中读出的内容，转换为python中的布尔型。</p>

<pre><code>class Boolean(Field):
    type = 'boolean'
    column_type = ('bool', 'bool')

    def convert_to_column(self, value, record):
        return bool(value)

    def convert_to_cache(self, value, record, validate=True):
        return bool(value)

    def convert_to_export(self, value, record):
        if record._context.get('export_raw_data'):
            return value
        return ustr(value)
</code></pre>

<p>其它类似得类还有很多：</p>

<ul>
<li>odoo.fields.Integer</li>
<li>odoo.fields.Float</li>
<li>odoo.fields.Float</li>
<li>odoo.fields.Monetary</li>
<li>odoo.fields._String</li>
<li>odoo.fields.Char</li>
<li>odoo.fields.Text</li>
<li>odoo.fields.Html</li>
<li>odoo.fields.Date</li>
<li>odoo.fields.Datetime</li>
<li>odoo.fields.Binary</li>
<li>odoo.fields.Selection</li>
<li>odoo.fields.Reference</li>
</ul>

<h3 id="关系类-odoo-fields-relational">关系类：odoo.fields._Relational</h3>

<p>还有一些特殊的字段用来处理一对多或多对一的关系，它们的父类是<code>odoo.fields._Relational</code></p>

<pre><code>class _Relational(Field):
    &quot;&quot;&quot; Abstract class for relational fields. &quot;&quot;&quot;
    relational = True
    _slots = {
        'domain': [],                   # domain for searching values
        'context': {},                  # context for searching values
    }
    ...
</code></pre>

<p>这个类型有如下子类：</p>

<ul>
<li>odoo.fields.Many2one</li>
<li>odoo.fields.One2many</li>
<li>odoo.fields.Many2many</li>
</ul>

<h3 id="主键类-odoo-fields-id">主键类：odoo.fields.Id</h3>

<p>每个模型类中都会有的字段，从这里可以看到，主键与<code>_ids</code>的关系。（曾经非常疑惑为什么通过<code>browse</code>获得模型类以后，可以访问<code>id</code>属性。从<code>__get__</code>函数里可以基本找到答案了。）</p>

<pre><code>class Id(Field):
&quot;&quot;&quot; Special case for field 'id'. &quot;&quot;&quot;
    type = 'integer'
    column_type = ('int4', 'int4')
    _slots = {
        'string': 'ID',
        'store': True,
        'readonly': True,
    }

    def __get__(self, record, owner):
        if record is None:
            return self         # the field is accessed through the class owner
        if not record:
            return False
        return record.ensure_one()._ids[0]

    def __set__(self, record, value):
        raise TypeError(&quot;field 'id' cannot be assigned&quot;)
</code></pre>

<h3 id="例子-odoo-addons-base-ir-res-res-users-users">例子：odoo.addons.base.ir.res.res_users.Users:</h3>

<p>依然以<code>users</code>为例子</p>

<pre><code>class Users(models.Model):
    _name = &quot;res.users&quot;
    _description = 'Users'
    _inherits = {'res.partner': 'partner_id'}
    _order = 'name, login'
    __uid_cache = defaultdict(dict)
    
    partner_id = fields.Many2one('res.partner', required=True, ondelete='restrict', auto_join=True,
        string='Related Partner', help='Partner-related data of the user')
    login = fields.Char(required=True, help=&quot;Used to log into the system&quot;)
    password = fields.Char(default='', invisible=True, copy=False,
        help=&quot;Keep empty if you don't want the user to be able to connect on the system.&quot;)
    new_password = fields.Char(string='Set Password',
        compute='_compute_password', inverse='_inverse_password',
        help=&quot;Specify a value only when creating a user or if you're &quot;\
             &quot;changing the user's password, otherwise leave empty. After &quot;\
             &quot;a change of password, the user has to login again.&quot;)
    signature = fields.Html()
    active = fields.Boolean(default=True)
    action_id = fields.Many2one('ir.actions.actions', string='Home Action',
        help=&quot;If specified, this action will be opened at log on for this user, in addition to the standard menu.&quot;)
    groups_id = fields.Many2many('res.groups', 'res_groups_users_rel', 'uid', 'gid', string='Groups', default=_default_groups)
    log_ids = fields.One2many('res.users.log', 'create_uid', string='User log entries')
    login_date = fields.Datetime(related='log_ids.create_date', string='Latest connection')
    share = fields.Boolean(compute='_compute_share', compute_sudo=True, string='Share User', store=True,
         help=&quot;External user with limited access, created only for the purpose of sharing data.&quot;)
    companies_count = fields.Integer(compute='_compute_companies_count', string=&quot;Number of Companies&quot;, default=_companies_count)
    tz_offset = fields.Char(compute='_compute_tz_offset', string='Timezone offset', invisible=True)

</code></pre>

<h3 id="不算总结的总结">不算总结的总结</h3>

<p>通过自己定的<code>Field</code>类型。<code>Odoo</code>实现了将数据库中读到的数据转化成python中的数据类型。但是仍然有些没有太搞清楚，如<code>many2one</code>、<code>one2many</code>这种类型。之后在使用中再研究它们。</p>


  
<div class="prev-next-post pure-g">
  <div class="pure-u-1-24" style="text-align: left;">
    
    <a href="https://asdfsx.github.io/post/odoo/odoo%E7%9A%84model/"><i class="fa fa-chevron-left"></i></a>
    
  </div>
  <div class="pure-u-10-24">
    
    <nav class="prev">
      <a href="https://asdfsx.github.io/post/odoo/odoo%E7%9A%84model/">odoo的模型 Model</a>
    </nav>
    
  </div>
  <div class="pure-u-2-24">
    &nbsp;
  </div>
  <div class="pure-u-10-24">
    
    <nav class="next">
      <a href="https://asdfsx.github.io/post/odoo/odoo%E7%9A%84%E9%98%B6%E6%AE%B5%E6%80%A7%E6%80%BB%E7%BB%93/">odoo的阶段性总结：服务器的启动、模块的加载、请求处理、页面生成</a>
    </nav>
    
  </div>
  <div class="pure-u-1-24" style="text-align: right;">
    
    <a href="https://asdfsx.github.io/post/odoo/odoo%E7%9A%84%E9%98%B6%E6%AE%B5%E6%80%A7%E6%80%BB%E7%BB%93/"><i class="fa fa-chevron-right"></i></a>
    
  </div>
</div>



  
<div id="disqus_thread"></div>
<script type="text/javascript">

(function() {
    
    
    if (window.location.hostname == "localhost")
        return;

    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'Your Disqus shortname';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


</div>

</div>
</div>
<script src="https://asdfsx.github.io/js/ui.js"></script>


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'Your Google Analytics tracking ID', 'auto');
  ga('send', 'pageview');

</script>



</body>
</html>

